"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebRouteUnit = void 0;
const express_1 = __importDefault(require("express"));
const body_parser_1 = __importDefault(require("body-parser"));
const fs_1 = require("fs");
const path_1 = require("path");
const zlib_1 = require("zlib");
const compression_1 = __importDefault(require("compression"));
const debug_1 = require("debug");
let Debug = debug_1.debug("mx-webserve");
let gRoutePath = process.mainModule ? path_1.parse(process.mainModule.filename).dir : process.cwd();
class WebRouteUnit {
    constructor() {
        this.app = express_1.default();
    }
    use(...handlers) {
        if (this.app)
            this.app.use(...handlers);
    }
    static(pre, root) {
        return this.app.use(pre, express_1.default.static(root, {}));
    }
    /**
     * 开启配置
     * @param setting
     */
    enable(setting) {
        this.app.enable(setting);
    }
    /**
     * 关闭配置
     * @param setting
     */
    disable(setting) {
        this.app.disable(setting);
    }
    _crossUse(req, res, next) {
        if (this.app.enabled("cross")) {
            res.header("Access-Control-Allow-Origin", "*");
            res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
            res.header("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
        }
        next();
    }
    _options(req, res, next) {
        res.end();
    }
    _404(req, res, next) {
        if (!res.headersSent) {
            // 表示有人处理过了
            res.writeHead(404);
            res.write(JSON.stringify({
                code: -1,
                errMsg: "can not find [" + req.path + "]"
            }));
        }
        res.end();
    }
    init(port, uses, limit) {
        if (this.app.enabled("init"))
            return Promise.resolve();
        this.app.use(this._crossUse.bind(this));
        this.app.options("*", this._options.bind(this));
        if (typeof limit == 'string') {
            limit = {
                text: limit,
                json: limit,
                urlencoded: limit,
                raw: limit,
            };
        }
        else if (limit == undefined) {
            limit = {};
        }
        this.app.use(body_parser_1.default.text({ limit: limit.text || '100kb' }));
        this.app.use(body_parser_1.default.raw({ limit: limit.raw || '100kb' }));
        this.app.use(body_parser_1.default.urlencoded({ extended: true, limit: limit.urlencoded || "10mb" }));
        this.app.use(body_parser_1.default.json({ limit: limit.json || '100kb' }));
        if (limit.gzip == true)
            this.app.use(compression_1.default());
        // 注册一下别人提交的内容
        this.app.use(this.favicon.bind(this));
        for (let i = 0; i < uses.length; i++) {
            this.app.use(uses[i]);
        }
        this.app.use(this._404.bind(this));
        this.load_favicon();
        this.app.enable("init");
        let server = this.app.listen(port);
        return new Promise((resolve, reject) => {
            // 建立一个web监控
            server.on("error", function (e) {
                Debug(e);
                reject(e);
            });
            server.on("listening", () => {
                Debug("listen on:" + port);
                resolve();
            });
        });
    }
    load_favicon() {
        try {
            this.favicon_data = zlib_1.gzipSync(fs_1.readFileSync(path_1.join(gRoutePath, "favicon.ico")));
        }
        catch (e) { }
    }
    favicon(req, res, next) {
        if (req.url == "/favicon.ico") {
            if (!this.favicon_data) {
                res.status(404);
            }
            else {
                res.writeHead(200, { "Content-Type": "image/x-icon", "Content-Encoding": "gzip" });
                res.write(this.favicon_data);
            }
            res.end();
        }
        else {
            next();
        }
    }
}
exports.WebRouteUnit = WebRouteUnit;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNEQUFtRTtBQUNuRSw4REFBcUM7QUFDckMsMkJBQWtDO0FBQ2xDLCtCQUFtQztBQUNuQywrQkFBZ0M7QUFFaEMsOERBQXFDO0FBRXJDLGlDQUE4QjtBQUM5QixJQUFJLEtBQUssR0FBRyxhQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7QUFHakMsSUFBSSxVQUFVLEdBQUksT0FBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsWUFBSyxDQUFFLE9BQWUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7QUFHL0csTUFBYSxZQUFZO0lBQ3JCO1FBR0EsUUFBRyxHQUF3QixpQkFBTyxFQUFFLENBQUM7SUFGckMsQ0FBQztJQUdNLEdBQUcsQ0FBQyxHQUFHLFFBQWU7UUFDekIsSUFBSSxJQUFJLENBQUMsR0FBRztZQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFXLEVBQUUsSUFBWTtRQUM3QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUNyRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLE9BQWU7UUFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDNUIsQ0FBQztJQUVEOzs7T0FHRztJQUNILE9BQU8sQ0FBQyxPQUFlO1FBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFTyxTQUFT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QyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FDaEQsQ0FBQztTQUNMO1FBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRztJQUNuQixDQUFDO0lBRU8sT0FBTyxDQUFDLEdBQW9CLEVBQUUsR0FBcUIsRUFBRSxJQUEwQjtRQUNuRixJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksY0FBYyxFQUFFO1lBQzNCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUNwQixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ2xCO2lCQUNJO2dCQUNELEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO2dCQUNuRixHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUNoQztZQUNELEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNiO2FBQU07WUFDSCxJQUFJLEVBQUUsQ0FBQztTQUNWO0lBQ0wsQ0FBQztDQUNKO0FBaElELG9DQWdJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFeHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGpvaW4sIHBhcnNlIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IGd6aXBTeW5jIH0gZnJvbSBcInpsaWJcIjtcblxuaW1wb3J0IGNvbXByZXNzaW9uIGZyb20gJ2NvbXByZXNzaW9uJ1xuXG5pbXBvcnQgeyBkZWJ1ZyB9IGZyb20gXCJkZWJ1Z1wiO1xubGV0IERlYnVnID0gZGVidWcoXCJteC13ZWJzZXJ2ZVwiKTtcblxuXG5sZXQgZ1JvdXRlUGF0aCA9IChwcm9jZXNzIGFzIGFueSkubWFpbk1vZHVsZSA/IHBhcnNlKChwcm9jZXNzIGFzIGFueSkubWFpbk1vZHVsZS5maWxlbmFtZSkuZGlyIDogcHJvY2Vzcy5jd2QoKTtcblxuXG5leHBvcnQgY2xhc3MgV2ViUm91dGVVbml0IHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICB9XG5cbiAgICBhcHA6IEV4cHJlc3MuQXBwbGljYXRpb24gPSBFeHByZXNzKCk7XG4gICAgcHVibGljIHVzZSguLi5oYW5kbGVyczogYW55W10pIHtcbiAgICAgICAgaWYgKHRoaXMuYXBwKSB0aGlzLmFwcC51c2UoLi4uaGFuZGxlcnMpO1xuICAgIH1cblxuICAgIHN0YXRpYyhwcmU6IHN0cmluZywgcm9vdDogc3RyaW5nKSB7XG4gICAgICAgcmV0dXJuIHRoaXMuYXBwLnVzZShwcmUsIEV4cHJlc3Muc3RhdGljKHJvb3QsIHt9KSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlvIDlkK/phY3nva5cbiAgICAgKiBAcGFyYW0gc2V0dGluZyBcbiAgICAgKi9cbiAgICBlbmFibGUoc2V0dGluZzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYXBwLmVuYWJsZShzZXR0aW5nKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWFs+mXremFjee9rlxuICAgICAqIEBwYXJhbSBzZXR0aW5nIFxuICAgICAqL1xuICAgIGRpc2FibGUoc2V0dGluZzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYXBwLmRpc2FibGUoc2V0dGluZylcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jcm9zc1VzZShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgICAgICBpZiAodGhpcy5hcHAuZW5hYmxlZChcImNyb3NzXCIpKSB7XG4gICAgICAgICAgICByZXMuaGVhZGVyKFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCIsIFwiKlwiKTtcbiAgICAgICAgICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzXCIsIFwiT3JpZ2luLCBYLVJlcXVlc3RlZC1XaXRoLCBDb250ZW50LVR5cGUsIEFjY2VwdFwiKTtcbiAgICAgICAgICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzXCIsIFwiR0VULFBPU1QsT1BUSU9OU1wiKTtcbiAgICAgICAgfVxuICAgICAgICBuZXh0KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb3B0aW9ucyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfNDA0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgICAgICAvLyDooajnpLrmnInkurrlpITnkIbov4fkuoZcbiAgICAgICAgICAgIHJlcy53cml0ZUhlYWQoNDA0KTtcbiAgICAgICAgICAgIHJlcy53cml0ZShcbiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IC0xLFxuICAgICAgICAgICAgICAgICAgICBlcnJNc2c6IFwiY2FuIG5vdCBmaW5kIFtcIiArIHJlcS5wYXRoICsgXCJdXCJcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGluaXQocG9ydDogbnVtYmVyLCB1c2VzOiBhbnlbXSwgbGltaXQ/OiBzdHJpbmcgfCB7IGpzb24/OiBzdHJpbmcsIHRleHQ/OiBzdHJpbmcsIHJhdz86IHN0cmluZywgdXJsZW5jb2RlZD86IHN0cmluZywgZ3ppcD86IGJvb2xlYW4sIFt4OiBzdHJpbmddOiBzdHJpbmcgfCBib29sZWFuIHwgdW5kZWZpbmVkIH0pIHtcbiAgICAgICAgaWYgKHRoaXMuYXBwLmVuYWJsZWQoXCJpbml0XCIpKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgdGhpcy5hcHAudXNlKHRoaXMuX2Nyb3NzVXNlLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLmFwcC5vcHRpb25zKFwiKlwiLCB0aGlzLl9vcHRpb25zLmJpbmQodGhpcykpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgbGltaXQgPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGxpbWl0ID0ge1xuICAgICAgICAgICAgICAgIHRleHQ6IGxpbWl0LFxuICAgICAgICAgICAgICAgIGpzb246IGxpbWl0LFxuICAgICAgICAgICAgICAgIHVybGVuY29kZWQ6IGxpbWl0LFxuICAgICAgICAgICAgICAgIHJhdzogbGltaXQsXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAobGltaXQgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsaW1pdCA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hcHAudXNlKGJvZHlQYXJzZXIudGV4dCh7IGxpbWl0OiBsaW1pdC50ZXh0IHx8ICcxMDBrYicgfSkpO1xuICAgICAgICB0aGlzLmFwcC51c2UoYm9keVBhcnNlci5yYXcoeyBsaW1pdDogbGltaXQucmF3IHx8ICcxMDBrYicgfSkpO1xuICAgICAgICB0aGlzLmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUsIGxpbWl0OiBsaW1pdC51cmxlbmNvZGVkIHx8IFwiMTBtYlwiIH0pKTtcbiAgICAgICAgdGhpcy5hcHAudXNlKGJvZHlQYXJzZXIuanNvbih7IGxpbWl0OiBsaW1pdC5qc29uIHx8ICcxMDBrYicgfSkpO1xuICAgICAgICBpZiAobGltaXQuZ3ppcCA9PSB0cnVlKSB0aGlzLmFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5cbiAgICAgICAgLy8g5rOo5YaM5LiA5LiL5Yir5Lq65o+Q5Lqk55qE5YaF5a65XG5cbiAgICAgICAgdGhpcy5hcHAudXNlKHRoaXMuZmF2aWNvbi5iaW5kKHRoaXMpKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1c2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLmFwcC51c2UodXNlc1tpXSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYXBwLnVzZSh0aGlzLl80MDQuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgdGhpcy5sb2FkX2Zhdmljb24oKTtcbiAgICAgICAgdGhpcy5hcHAuZW5hYmxlKFwiaW5pdFwiKTtcbiAgICAgICAgbGV0IHNlcnZlciA9IHRoaXMuYXBwLmxpc3Rlbihwb3J0KTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIC8vIOW7uueri+S4gOS4qndlYuebkeaOp1xuICAgICAgICAgICAgc2VydmVyLm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBEZWJ1ZyhlKTtcbiAgICAgICAgICAgICAgICByZWplY3QoZSlcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzZXJ2ZXIub24oXCJsaXN0ZW5pbmdcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIERlYnVnKFwibGlzdGVuIG9uOlwiICsgcG9ydCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBwcml2YXRlIGZhdmljb25fZGF0YSE6IEJ1ZmZlcjtcbiAgICBsb2FkX2Zhdmljb24oKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmZhdmljb25fZGF0YSA9IGd6aXBTeW5jKFxuICAgICAgICAgICAgICAgIHJlYWRGaWxlU3luYyhqb2luKGdSb3V0ZVBhdGgsIFwiZmF2aWNvbi5pY29cIikpXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlKSB7IH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZhdmljb24ocmVxOiBFeHByZXNzLlJlcXVlc3QsIHJlczogRXhwcmVzcy5SZXNwb25zZSwgbmV4dDogRXhwcmVzcy5OZXh0RnVuY3Rpb24pIHtcbiAgICAgICAgaWYgKHJlcS51cmwgPT0gXCIvZmF2aWNvbi5pY29cIikge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmZhdmljb25fZGF0YSkge1xuICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoNDA0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHsgXCJDb250ZW50LVR5cGVcIjogXCJpbWFnZS94LWljb25cIiwgXCJDb250ZW50LUVuY29kaW5nXCI6IFwiZ3ppcFwiIH0pO1xuICAgICAgICAgICAgICAgIHJlcy53cml0ZSh0aGlzLmZhdmljb25fZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=